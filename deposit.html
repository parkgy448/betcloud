<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deposit | BetCloud Revolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Firebase and dependencies -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;800&display=swap');
        body {
            font-family: 'Oxanium', sans-serif;
            background-color: #0a0a12;
            color: white;
        }
        .active-tab {
            background-color: #f97316;
            color: white;
        }
        .amount-btn.active {
            background-color: #f97316;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <i data-feather="cloud" class="text-orange-500 mr-2"></i>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-orange-500 to-yellow-400 bg-clip-text text-transparent">
                    BETCLOUD
                </h1>
                <span class="ml-2 text-xs text-gray-400">SINCE 2016</span>
            </div>
            <a href="index.html" class="text-gray-400 hover:text-white">
                <i data-feather="x"></i>
            </a>
        </header>

        <!-- User Info - Dynamic -->
        <div id="userInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="requestTab" class="flex-1 py-2 font-bold active-tab">충전신청</button>
            <button id="historyTab" class="flex-1 py-2 font-bold text-gray-400">충전내역</button>
        </div>

        <!-- Charge Request Tab -->
        <div id="chargeRequestTab" class="charge-tab-content active">
            <!-- Account Verification -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">충전계좌정보</h3>
                <div class="space-y-4">
                    <div class="relative">
                        <label class="block text-sm text-gray-400 mb-1">출금비밀번호</label>
                        <input type="password" id="withdrawPassword" class="w-full bg-gray-700 rounded p-2 pr-10" placeholder="출금비밀번호 입력">
                        <button onclick="togglePassword('withdrawPassword', 'withdrawEyeIcon')" class="absolute right-2 top-7 text-gray-400 hover:text-white">
                            <i data-feather="eye" id="withdrawEyeIcon" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <!-- Account Verification Section -->
                    <div class="bg-gray-900 rounded-lg p-4">
                        <h4 class="font-bold text-orange-400 mb-2">입금 계좌 확인</h4>
                        <div id="accountResult" class="text-sm text-gray-300 mb-3">
                            계좌확인을 위해 비밀번호를 입력해주세요
                        </div>
                        <div id="accountPwWrap" class="hidden">
                            <div class="flex space-x-2 mb-2">
                                <input type="password" id="accountCheckPassword" class="flex-1 bg-gray-700 rounded p-2" placeholder="비밀번호 입력">
                                <button id="accountPwConfirmBtn" class="bg-orange-500 hover:bg-orange-600 px-4 rounded">확인</button>
                            </div>
                        </div>
                        <button id="verifyAccountBtn" class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded">
                            계좌 확인하기
                        </button>
                    </div>
                </div>
            </div>

            <!-- Deposit Amount -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">충전금액</h3>
                <div class="mb-4">
                    <input type="text" id="customChargeAmount" class="w-full bg-gray-700 rounded p-2 mb-2" placeholder="직접 입력 (숫자만)">
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="selectChargeAmount(10000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">10,000원</button>
                        <button onclick="selectChargeAmount(30000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">30,000원</button>
                        <button onclick="selectChargeAmount(50000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">50,000원</button>
                        <button onclick="selectChargeAmount(100000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">100,000원</button>
                        <button onclick="selectChargeAmount(500000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">500,000원</button>
                        <button onclick="selectChargeAmount(1000000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">1,000,000원</button>
                        <button onclick="selectChargeAmount(10000000)" class="amount-btn bg-gray-700 hover:bg-gray-600 py-3 rounded">10,000,000원</button>
                        <button onclick="resetChargeAmount()" class="bg-orange-500 hover:bg-orange-600 py-3 rounded">정정</button>
                    </div>
                </div>

                <!-- Point Options -->
                <div class="mb-4">
                    <h4 class="font-bold mb-3">포인트 옵션 선택</h4>
                    <div class="space-y-2">
                        <label class="flex items-start p-3 bg-gray-700 rounded-lg cursor-pointer">
                            <input type="radio" name="pointOption" id="option1" class="mr-3 mt-1" value="option1">
                            <div>
                                <h4 class="font-bold text-orange-400">카지노 롤링 100%</h4>
                                <p class="text-xs text-gray-300">카지노 롤링 100% 보너스</p>
                            </div>
                        </label>
                        <label class="flex items-start p-3 bg-gray-700 rounded-lg cursor-pointer">
                            <input type="radio" name="pointOption" id="option2" class="mr-3 mt-1" value="option2">
                            <div>
                                <h4 class="font-bold text-orange-400">슬롯 첫충 10% 매충 5%</h4>
                                <p class="text-xs text-gray-300">슬롯 전용 보너스</p>
                            </div>
                        </label>
                        <label class="flex items-start p-3 bg-gray-700 rounded-lg cursor-pointer">
                            <input type="radio" name="pointOption" id="option3" class="mr-3 mt-1" value="option3">
                            <div>
                                <h4 class="font-bold text-orange-400">포인트 미지급</h4>
                                <p class="text-xs text-green-400">단폴배팅, 1.50+배당 가능 (롤링X)</p>
                            </div>
                        </label>
                    </div>
                </div>

                <button id="submitChargeBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-bold">
                    충전신청
                </button>
            </div>
        </div>

        <!-- Charge History Tab -->
        <div id="chargeHistoryTab" class="charge-tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="font-bold mb-4">충전 내역</h3>
                <div id="chargeHistoryList" class="space-y-2">
                    <!-- History will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Notices -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-3 text-red-400">충전 전 필독사항</h3>
            <ul class="space-y-3 text-sm">
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>반드시 현재 계좌번호를 확인하세요. (변경 가능성 있음)</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>무통장(카카오페이/토스뱅크/ATM) 입금 가능</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>1회 최대 3,990,000원까지 가능 (초과시 분할입금 필수)</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>본인명의 계좌에서 입금 가능 (타인명의도 가능)</span>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <footer class="text-center text-xs text-gray-500 mt-6">
            <p>COPYRIGHT © BETCLOUD ALL RIGHTS RESERVED</p>
        </footer>

        <!-- Support Button -->
        <button class="fixed bottom-6 right-6 bg-orange-500 text-white p-3 rounded-full shadow-lg">
            <i data-feather="message-square"></i>
        </button>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 flex items-center">
            <i data-feather="loader" class="w-8 h-8 text-orange-500 animate-spin mr-3"></i>
            <span>처리 중...</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyAr_S6URDXWbjQ4Gh0Nw_JOeTkHA_G8Uis",
    authDomain: "cloud-casino-34cc6.firebaseapp.com",
    projectId: "cloud-casino-34cc6",
    storageBucket: "cloud-casino-34cc6.firebasestorage.app",
    messagingSenderId: "289867400095",
    appId: "1:289867400095:web:c9060c2a534225db9cf3aa"
  };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentDepositAccount = "";
        let isAccountVerified = false;

        // Helper Functions
        function showLoading() {
            document.getElementById("loadingSpinner").classList.remove("hidden");
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").classList.add("hidden");
        }

        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('data-feather', 'eye-off');
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        // Update User Info
        function updateUserInfo(user) {
            const userInfoSection = document.getElementById("userInfoSection");
            
            if (user) {
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userInfoSection.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold">${userData.name || userData.userId} 님</h3>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">${(userData.point || 0).toLocaleString()}P</span>
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${(userData.balance || 0).toLocaleString()}원</span>
                                        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">${(userData.balance || 0).toLocaleString()}원</span>
                                    </div>
                                </div>
                                <button class="text-gray-400 hover:text-white">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        `;
                        feather.replace();
                    }
                });
            } else {
                userInfoSection.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400">로그인이 필요합니다</p>
                        <a href="index.html" class="text-orange-400 hover:text-orange-300 text-sm">로그인 페이지로 이동</a>
                    </div>
                `;
            }
        }

        // Tab Management
        document.getElementById("requestTab").addEventListener("click", function() {
            document.getElementById("requestTab").classList.add("active-tab");
            document.getElementById("historyTab").classList.remove("active-tab");
            document.getElementById("chargeRequestTab").classList.add("active");
            document.getElementById("chargeHistoryTab").classList.remove("active");
        });

        document.getElementById("historyTab").addEventListener("click", function() {
            document.getElementById("historyTab").classList.add("active-tab");
            document.getElementById("requestTab").classList.remove("active-tab");
            document.getElementById("chargeHistoryTab").classList.add("active");
            document.getElementById("chargeRequestTab").classList.remove("active");
            loadChargeHistory();
        });

        // Amount Selection
        let currentChargeAmount = 0;
        function selectChargeAmount(amount) {
            currentChargeAmount = amount;
            document.getElementById("customChargeAmount").value = amount.toLocaleString() + '원';
            
            // Remove active class from all buttons
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        function resetChargeAmount() {
            currentChargeAmount = 0;
            document.getElementById("customChargeAmount").value = '';
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Custom amount input
        document.getElementById('customChargeAmount').addEventListener('input', function(e) {
            const value = e.target.value.replace(/[^0-9]/g, '');
            currentChargeAmount = value ? parseInt(value) : 0;
            e.target.value = value ? parseInt(value).toLocaleString() + '원' : '';
            
            // Remove active class from preset buttons when typing
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        });

        // Account Verification
        function loadDepositAccount() {
            db.collection("config").doc("depositAccount")
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const { bank, accountNumber, holder } = doc.data();
                        currentDepositAccount = `${bank} ${accountNumber} / 예금주: ${holder}`;
                    }
                });
        }

        document.getElementById("verifyAccountBtn").addEventListener("click", () => {
            if (isAccountVerified) {
                navigator.clipboard.writeText(currentDepositAccount).then(() => {
                    const btn = document.getElementById("verifyAccountBtn");
                    const originalText = btn.textContent;
                    btn.textContent = "복사됨!";
                    btn.style.backgroundColor = "#10B981";
                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.backgroundColor = "";
                    }, 2000);
                });
                return;
            }

            document.getElementById("accountPwWrap").classList.remove("hidden");
            document.getElementById("accountCheckPassword").focus();
        });

        document.getElementById("accountPwConfirmBtn").addEventListener("click", async () => {
            const password = document.getElementById("accountCheckPassword").value.trim();
            if (!password) {
                alert("비밀번호를 입력하세요");
                return;
            }

            const user = auth.currentUser;
            if (!user) {
                alert("로그인이 필요합니다.");
                return;
            }

            showLoading();
            try {
                const credential = firebase.auth.EmailAuthProvider.credential(user.email, password);
                await user.reauthenticateWithCredential(credential);

                document.getElementById("accountResult").textContent = currentDepositAccount;
                document.getElementById("accountPwWrap").classList.add("hidden");
                isAccountVerified = true;
                document.getElementById("verifyAccountBtn").textContent = "복사";
                document.getElementById("verifyAccountBtn").style.backgroundColor = "#3B82F6";
            } catch (e) {
                alert("비밀번호가 일치하지 않습니다");
                document.getElementById("accountCheckPassword").value = "";
            } finally {
                hideLoading();
            }
        });

        // Charge Submission
        document.getElementById("submitChargeBtn").addEventListener("click", async function() {
            const password = document.getElementById("withdrawPassword").value.trim();
            const selectedOption = document.querySelector('input[name="pointOption"]:checked');

            if (!currentChargeAmount || currentChargeAmount < 10000) {
                alert("최소 10,000원 이상 입력해주세요");
                return;
            }

            if (!password) {
                alert("출금 비밀번호를 입력해주세요");
                return;
            }

            if (!selectedOption) {
                alert("포인트 옵션을 선택해주세요");
                return;
            }

            showLoading();
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("로그인이 필요합니다");

                const userDoc = await db.collection("users").doc(user.uid).get();
                if (!userDoc.exists) throw new Error("사용자 정보를 찾을 수 없습니다");

                // Verify withdraw password
                if (!bcrypt || typeof bcrypt.compareSync !== "function") {
                    alert("암호화 라이브러리가 로딩되지 않았습니다.");
                    return;
                }

                if (!bcrypt.compareSync(password, userDoc.data().withdrawPassword)) {
                    throw new Error("출금 비밀번호가 일치하지 않습니다");
                }

                // Submit charge request
                await db.collection("chargeRequests").add({
                    userId: user.uid,
                    userName: userDoc.data().name || userDoc.data().userId,
                    amount: currentChargeAmount,
                    date: new Date().toISOString(),
                    status: "pending",
                    pointOption: selectedOption.id,
                    adminNote: "",
                    userBank: userDoc.data().bank,
                    userAccount: userDoc.data().account,
                    userAccountName: userDoc.data().accountName,
                });

                // Show success notification
                showChargeSuccessNotification(currentChargeAmount);
                
                // Reset form
                document.getElementById("withdrawPassword").value = "";
                document.getElementById("customChargeAmount").value = "";
                resetChargeAmount();
                document.querySelectorAll('input[name="pointOption"]').forEach(opt => opt.checked = false);
                
            } catch (error) {
                console.error("충전 신청 오류:", error);
                alert("충전 신청 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
            }
        });

        function showChargeSuccessNotification(amount) {
            const notification = document.createElement("div");
            notification.className = "fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                    ${amount.toLocaleString()}원 충전 신청 완료!
                </div>
            `;
            document.body.appendChild(notification);
            feather.replace();

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Load Charge History
        function loadChargeHistory() {
            const historyList = document.getElementById("chargeHistoryList");
            const user = auth.currentUser;

            if (!user) {
                historyList.innerHTML = '<div class="text-center text-gray-400 py-4">로그인이 필요합니다</div>';
                return;
            }

            showLoading();
            db.collection("chargeRequests")
                .where("userId", "==", user.uid)
                .orderBy("date", "desc")
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        historyList.innerHTML = '<div class="text-center text-gray-400 py-4">충전 내역이 없습니다</div>';
                        return;
                    }

                    historyList.innerHTML = "";
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const historyItem = document.createElement("div");
                        historyItem.className = "flex justify-between items-center bg-gray-700 p-3 rounded";
                        
                        let statusClass = "text-yellow-400";
                        let statusText = "대기중";

                        if (item.status === "approved") {
                            statusClass = "text-green-400";
                            statusText = "승인됨";
                        } else if (item.status === "rejected") {
                            statusClass = "text-red-400";
                            statusText = "거절됨";
                        }

                        historyItem.innerHTML = `
                            <div>
                                <div class="text-sm">${new Date(item.date).toLocaleString()}</div>
                                <div class="text-xs text-gray-400">${item.pointOption || ""}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">${item.amount.toLocaleString()}원</div>
                                <div class="text-xs ${statusClass}">${statusText}</div>
                            </div>
                        `;
                        historyList.appendChild(historyItem);
                    });
                })
                .catch((error) => {
                    console.error("충전 내역 로드 오류:", error);
                    historyList.innerHTML = '<div class="text-center text-red-400 py-4">내역을 불러오는 중 오류 발생</div>';
                })
                .finally(() => hideLoading());
        }

        // Initialize
        feather.replace();
        auth.onAuthStateChanged((user) => {
            updateUserInfo(user);
            if (user) {
                loadDepositAccount();
            }
        });
    </script>
</body>
</html>
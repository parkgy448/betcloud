<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자금 이체 | BETCLOUD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
    
    <!-- Firebase and dependencies -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;800&display=swap');
        body {
            font-family: 'Oxanium', sans-serif;
            background-color: #0a0a12;
            color: white;
        }
        .transfer-btn {
            transition: all 0.2s ease;
        }
        .transfer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="vanta-bg" class="fixed inset-0 z-0"></div>
    
    <div class="relative z-10 container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <i data-feather="cloud" class="text-orange-500 mr-2"></i>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-orange-500 to-yellow-400 bg-clip-text text-transparent">
                        BETCLOUD
                    </h1>
                </div>
                <a href="index.html" class="text-gray-400 hover:text-white">
                    <i data-feather="x"></i>
                </a>
            </div>
        </header>

        <!-- Balance Info - Dynamic -->
        <div id="balanceInfo" class="bg-gradient-to-r from-gray-900 to-gray-800 rounded-lg p-4 mb-6">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Transfer Module -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-3 text-center">카지노개입</h3>
            <p class="text-sm text-gray-300 mb-4">
                게임머니에서 원하시는 금액을 입력하시고 카지노머니로 전환하신 후 카지노게임에 입장하실 수 있습니다.<br><br>
                카지노게임 종료 후 게임머니로 전환하지 않으시면 스포츠베팅 및 환전이 불가능합니다.
            </p>
            
            <!-- Transfer Module -->
            <div class="space-y-4 mb-4">
                <div class="bg-gray-700 rounded p-3 text-center">
                    <p class="text-sm text-gray-400 mb-1">게임 머니</p>
                    <p id="gameMoney" class="font-bold">0 원</p>
                </div>
                
                <div class="relative">
                    <input type="number" id="transferAmount" class="w-full bg-gray-700 rounded p-3 text-center font-bold" placeholder="전환할 금액">
                    <div class="grid grid-cols-4 gap-1 mt-2">
                        <button onclick="addTransferAmount(10000)" class="bg-gray-600 hover:bg-gray-500 py-2 rounded text-xs">1만</button>
                        <button onclick="addTransferAmount(50000)" class="bg-gray-600 hover:bg-gray-500 py-2 rounded text-xs">5만</button>
                        <button onclick="addTransferAmount(100000)" class="bg-gray-600 hover:bg-gray-500 py-2 rounded text-xs">10만</button>
                        <button onclick="addTransferAmount(500000)" class="bg-gray-600 hover:bg-gray-500 py-2 rounded text-xs">50만</button>
                    </div>
                </div>
                
                <div class="bg-gray-700 rounded p-3 text-center">
                    <p class="text-sm text-gray-400 mb-1">카지노 머니</p>
                    <p id="casinoMoney" class="font-bold">0 원</p>
                </div>
            </div>

            <!-- Transfer Buttons -->
            <div class="grid gap-3 mb-6">
                <button id="toCasinoBtn" class="transfer-btn bg-orange-600 hover:bg-orange-700 py-3 rounded-lg font-bold flex items-center justify-center">
                    카지노머니로 전환 <i data-feather="arrow-down" class="ml-2 w-4 h-4"></i>
                </button>
                <button id="toGameBtn" class="transfer-btn bg-blue-600 hover:bg-blue-700 py-3 rounded-lg font-bold flex items-center justify-center">
                    게임머니로 전환 <i data-feather="arrow-up" class="ml-2 w-4 h-4"></i>
                </button>
            </div>

            <!-- Password Section -->
            <div class="bg-gray-700 rounded-lg p-4">
                <h4 class="font-bold mb-2">출금 비밀번호 확인</h4>
                <div class="relative">
                    <input type="password" id="transferPassword" class="w-full bg-gray-600 rounded p-2 pr-10" placeholder="출금 비밀번호 입력">
                    <button onclick="togglePassword('transferPassword', 'transferEyeIcon')" class="absolute right-2 top-2 text-gray-400 hover:text-white">
                        <i data-feather="eye" id="transferEyeIcon" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Casino Providers -->
        <div class="mb-6">
            <h3 class="font-bold mb-3 text-center">카지노 게임</h3>
            <div class="grid grid-cols-3 gap-2 mb-2">
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('evolution')">
                    아블루션<br>EVOLUTION
                </a>
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('dreamgaming')">
                    드림게이딩<br>DREAMGAMING
                </a>
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('pragmatic')">
                    프라그마틱<br>PRAGMATICALLY
                </a>
            </div>
            <div class="grid grid-cols-3 gap-2">
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('oriental')">
                    오리엔탈게이딩<br>ORIENTAL
                </a>
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('microgaming')">
                    마이크로게이딩<br>MICROGAINING
                </a>
                <a href="#" class="bg-gray-800 hover:bg-gray-700 rounded p-3 text-center text-xs" onclick="guardGameAccess('asiagaming')">
                    아시안게이딩<br>ASIAGAMING
                </a>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center text-xs text-gray-500">
            <p>bc-mvp.com</p>
        </footer>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 flex items-center">
            <i data-feather="loader" class="w-8 h-8 text-orange-500 animate-spin mr-3"></i>
            <span>처리 중...</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyAr_S6URDXWbjQ4Gh0Nw_JOeTkHA_G8Uis",
    authDomain: "cloud-casino-34cc6.firebaseapp.com",
    projectId: "cloud-casino-34cc6",
    storageBucket: "cloud-casino-34cc6.firebasestorage.app",
    messagingSenderId: "289867400095",
    appId: "1:289867400095:web:c9060c2a534225db9cf3aa"
  };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        // Vanta.js Background
        VANTA.GLOBE({
            el: "#vanta-bg",
            mouseControls: true,
            touchControls: true,
            gyroControls: false,
            minHeight: 200.00,
            minWidth: 200.00,
            scale: 1.00,
            scaleMobile: 1.00,
            color: 0xff6600,
            backgroundColor: 0x0a0a12,
            size: 0.7
        });

        // Helper Functions
        function showLoading() {
            document.getElementById("loadingSpinner").classList.remove("hidden");
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").classList.add("hidden");
        }

        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('data-feather', 'eye-off');
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        // Update Balance Info
        function updateBalanceInfo(user) {
            const balanceInfo = document.getElementById("balanceInfo");
            
            if (user) {
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const gameBalance = userData.balance || 0;
                        const casinoBalance = userData.casinoBalance || 0;
                        
                        balanceInfo.innerHTML = `
                            <h3 class="font-bold mb-2">${userData.name || userData.userId} 님</h3>
                            <div class="text-center py-3 border-b border-gray-700">
                                <span class="text-2xl font-bold">${gameBalance.toLocaleString()} 원</span>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mt-3 text-sm">
                                <div class="text-center">
                                    <div class="text-gray-400">게임머니</div>
                                    <div class="font-bold text-green-400">${gameBalance.toLocaleString()}원</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-gray-400">카지노머니</div>
                                    <div class="font-bold text-blue-400">${casinoBalance.toLocaleString()}원</div>
                                </div>
                            </div>
                        `;

                        // Update transfer display
                        document.getElementById("gameMoney").textContent = gameBalance.toLocaleString() + " 원";
                        document.getElementById("casinoMoney").textContent = casinoBalance.toLocaleString() + " 원";
                    }
                });
            } else {
                balanceInfo.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400">로그인이 필요합니다</p>
                        <a href="index.html" class="text-orange-400 hover:text-orange-300 text-sm">로그인 페이지로 이동</a>
                    </div>
                `;
            }
        }

        // Amount Management
        let transferAmount = 0;

        function addTransferAmount(amount) {
            transferAmount += amount;
            document.getElementById("transferAmount").value = transferAmount;
        }

        document.getElementById("transferAmount").addEventListener("input", function(e) {
            transferAmount = parseInt(e.target.value) || 0;
        });

        // Transfer Functions
        document.getElementById("toCasinoBtn").addEventListener("click", async function() {
            await processTransfer("toCasino");
        });

        document.getElementById("toGameBtn").addEventListener("click", async function() {
            await processTransfer("toGame");
        });

        async function processTransfer(direction) {
            const password = document.getElementById("transferPassword").value.trim();
            
            if (transferAmount <= 0) {
                alert("전환할 금액을 입력해주세요");
                return;
            }

            if (!password) {
                alert("출금 비밀번호를 입력해주세요");
                return;
            }

            showLoading();
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("로그인이 필요합니다");

                const userDoc = await db.collection("users").doc(user.uid).get();
                if (!userDoc.exists) throw new Error("사용자 정보를 찾을 수 없습니다");

                const userData = userDoc.data();
                const gameBalance = userData.balance || 0;
                const casinoBalance = userData.casinoBalance || 0;

                // Verify withdraw password
                const BCRYPT = window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt);
                if (!BCRYPT || typeof BCRYPT.compareSync !== "function") {
                    alert("암호화 라이브러리가 로딩되지 않았습니다.");
                    return;
                }

                const storedPwd = userData.withdrawPassword || "";
                const looksHashed = /^\$2[aby]\$/.test(storedPwd);
                const verified = looksHashed ? (BCRYPT && BCRYPT.compareSync(password, storedPwd)) : (password === storedPwd);
                if (!verified) {
                    throw new Error("출금 비밀번호가 일치하지 않습니다");
                }

                let newGameBalance = gameBalance;
                let newCasinoBalance = casinoBalance;

                if (direction === "toCasino") {
                    if (gameBalance < transferAmount) {
                        throw new Error("게임 머니가 부족합니다");
                    }
                    newGameBalance = gameBalance - transferAmount;
                    newCasinoBalance = casinoBalance + transferAmount;
                } else {
                    if (casinoBalance < transferAmount) {
                        throw new Error("카지노 머니가 부족합니다");
                    }
                    newGameBalance = gameBalance + transferAmount;
                    newCasinoBalance = casinoBalance - transferAmount;
                }

                // Update balances
                await db.collection("users").doc(user.uid).update({
                    balance: newGameBalance,
                    casinoBalance: newCasinoBalance
                });

                // Log transfer
                await db.collection("transferLogs").add({
                    userId: user.uid,
                    userName: userData.name || userData.userId,
                    direction: direction,
                    amount: transferAmount,
                    date: new Date().toISOString(),
                    gameBalanceBefore: gameBalance,
                    casinoBalanceBefore: casinoBalance,
                    gameBalanceAfter: newGameBalance,
                    casinoBalanceAfter: newCasinoBalance
                });

                // Show success message
                const directionText = direction === "toCasino" ? "카지노 머니로" : "게임 머니로";
                showTransferSuccessNotification(transferAmount, directionText);
                
                // Reset form
                document.getElementById("transferPassword").value = "";
                document.getElementById("transferAmount").value = "";
                transferAmount = 0;
                
                // Update display
                updateBalanceInfo(user);
                
            } catch (error) {
                console.error("자금 이체 오류:", error);
                alert("자금 이체 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
            }
        }

        function showTransferSuccessNotification(amount, direction) {
            const notification = document.createElement("div");
            notification.className = "fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                    ${amount.toLocaleString()}원 ${direction} 전환 완료!
                </div>
            `;
            document.body.appendChild(notification);
            feather.replace();

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Game Access Guard
        function guardGameAccess(provider) {
            const user = auth.currentUser;
            if (!user) {
                alert("로그인이 필요합니다");
                return false;
            }
            
            db.collection("users").doc(user.uid).get().then((doc) => {
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.status !== "active") {
                        alert("승인 대기 중인 계정입니다. 관리자 승인 후 이용 가능합니다.");
                        return false;
                    }
                    
                    const casinoBalance = userData.casinoBalance || 0;
                    if (casinoBalance <= 0) {
                        alert("카지노 머니가 없습니다. 먼저 자금을 카지노 머니로 전환해주세요.");
                        return false;
                    }
                    
                    // In real implementation, this would redirect to the actual game
                    alert(`${provider} 게임에 접속합니다! (데모)`);
                }
            });
            return true;
        }

        // Initialize
        feather.replace();
        auth.onAuthStateChanged((user) => {
            updateBalanceInfo(user);
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exchange | BetCloud Revolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    
    <!-- Firebase and dependencies -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="auth.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;800&display=swap');
        body {
            font-family: 'Oxanium', sans-serif;
            background-color: #0a0a12;
            color: white;
        }
        .active-tab {
            background-color: #f97316;
            color: white;
        }
        .preset-btn.active {
            background-color: #f97316;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center">
                <i data-feather="cloud" class="text-orange-500 mr-2"></i>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-orange-500 to-yellow-400 bg-clip-text text-transparent">
                    BETCLOUD
                </h1>
                <span class="ml-2 text-xs text-gray-400">SINCE 2016</span>
            </div>
            <a href="index.html" class="text-gray-400 hover:text-white">
                <i data-feather="x"></i>
            </a>
        </header>

        <!-- User Info - Dynamic -->
        <div id="userInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6">
            <!-- Will be populated by JavaScript -->
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="exchangeRequestTab" class="flex-1 py-2 font-bold active-tab">환전하기</button>
            <button id="exchangeHistoryTab" class="flex-1 py-2 font-bold text-gray-400">환전내역</button>
        </div>

        <!-- Exchange Request Tab -->
        <div id="exchangeRequestContent" class="exchange-tab-content active">
            <!-- Bank Account Info -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">환전계좌정보</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">출금비밀번호</label>
                        <div class="relative">
                            <input type="password" id="exchangePassword" class="w-full bg-gray-700 rounded p-2 pr-10" placeholder="출금비밀번호 입력">
                            <button onclick="togglePassword('exchangePassword', 'exchangeEyeIcon')" class="absolute right-2 top-2 text-gray-400 hover:text-white">
                                <i data-feather="eye" id="exchangeEyeIcon" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">은행명</label>
                        <div id="userBank" class="bg-gray-700 rounded p-2">-</div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">계좌번호</label>
                        <div id="userAccount" class="bg-gray-700 rounded p-2">-</div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">예금주</label>
                        <div id="userAccountName" class="bg-gray-700 rounded p-2">-</div>
                    </div>
                </div>
            </div>

            <!-- Exchange Amount -->
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">환전금액</h3>
                <div class="mb-4">
                    <div class="flex items-center mb-2">
                        <span class="text-sm text-gray-400 mr-2">현재 잔액:</span>
                        <span id="currentBalance" class="font-bold text-orange-400">0원</span>
                    </div>
                    <input type="text" id="exchangeAmount" class="w-full bg-gray-700 rounded p-2 mb-2" placeholder="직접 입력 (숫자만)">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectExchangeAmount(10000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">10,000원</button>
                        <button onclick="selectExchangeAmount(30000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">30,000원</button>
                        <button onclick="selectExchangeAmount(50000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">50,000원</button>
                        <button onclick="selectExchangeAmount(100000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">100,000원</button>
                        <button onclick="selectExchangeAmount(500000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">500,000원</button>
                        <button onclick="selectExchangeAmount(1000000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">1,000,000원</button>
                    </div>
                </div>
                <button id="submitExchangeBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-bold">
                    환전신청
                </button>
            </div>
        </div>

        <!-- Exchange History Tab -->
        <div id="exchangeHistoryContent" class="exchange-tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="font-bold mb-4">환전 내역</h3>
                <div id="exchangeHistoryList" class="space-y-2">
                    <!-- History will be populated by JavaScript -->
                </div>
            </div>
        </div>

        <!-- Rolling Info -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-4">롤링 현황</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div>
                    <div class="flex justify-between mb-1">
                        <span>스포츠</span>
                        <span>0% (0원)</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span>미니게임</span>
                        <span>0% (0원)</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span>카지노</span>
                        <span>0% (0원)</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between mb-1">
                        <span>슬롯</span>
                        <span>0% (0원)</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2">
                        <div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notices -->
        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-3 text-red-400">환전 전 필독사항</h3>
            <ul class="space-y-3 text-sm">
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>최소 환전 금액은 <span class="text-orange-400">10,000원</span>부터 가능합니다.</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>1일 최대 환전 가능 금액은 <span class="text-orange-400">5,000,000원</span> 입니다.</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>환전은 <span class="text-orange-400">영업일 기준 1~3시간</span> 이내 처리됩니다.</span>
                </li>
                <li class="flex items-start">
                    <i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i>
                    <span>미완료 롤링이 있는 경우 환전이 제한될 수 있습니다.</span>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <footer class="text-center text-xs text-gray-500 mt-6">
            <p>© 2023 BETCLOUD REVOLUTION</p>
            <p class="mt-1">bc-mvp.com</p>
        </footer>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 flex items-center">
            <i data-feather="loader" class="w-8 h-8 text-orange-500 animate-spin mr-3"></i>
            <span>처리 중...</span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
    apiKey: "AIzaSyAr_S6URDXWbjQ4Gh0Nw_JOeTkHA_G8Uis",
    authDomain: "cloud-casino-34cc6.firebaseapp.com",
    projectId: "cloud-casino-34cc6",
    storageBucket: "cloud-casino-34cc6.firebasestorage.app",
    messagingSenderId: "289867400095",
    appId: "1:289867400095:web:c9060c2a534225db9cf3aa"
  };

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const db = firebase.firestore();
        const auth = firebase.auth();

        // Helper Functions
        function showLoading() {
            document.getElementById("loadingSpinner").classList.remove("hidden");
        }

        function hideLoading() {
            document.getElementById("loadingSpinner").classList.add("hidden");
        }

        function togglePassword(inputId, iconId) {
            const passwordInput = document.getElementById(inputId);
            const eyeIcon = document.getElementById(iconId);
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                eyeIcon.setAttribute('data-feather', 'eye-off');
            } else {
                passwordInput.type = 'password';
                eyeIcon.setAttribute('data-feather', 'eye');
            }
            feather.replace();
        }

        // Update User Info and Balance
        function updateUserInfo(user) {
            const userInfoSection = document.getElementById("userInfoSection");
            
            if (user) {
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        userInfoSection.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold">${userData.name || userData.userId} 님</h3>
                                    <div class="flex items-center space-x-2 mt-2">
                                        <span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">${(userData.point || 0).toLocaleString()}P</span>
                                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${(userData.balance || 0).toLocaleString()}원</span>
                                        <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded">${(userData.balance || 0).toLocaleString()}원</span>
                                    </div>
                                </div>
                                <button onclick="refreshBalance()" class="text-gray-400 hover:text-white">
                                    <i data-feather="refresh-cw"></i>
                                </button>
                            </div>
                        `;

                        // Update bank info
                        document.getElementById("userBank").textContent = userData.bank || "-";
                        document.getElementById("userAccount").textContent = userData.account ? userData.account.replace(/(\d{3})(\d{4})(\d{4})/, "$1-****-$3") : "-";
                        document.getElementById("userAccountName").textContent = userData.accountName || "-";
                        document.getElementById("currentBalance").textContent = (userData.balance || 0).toLocaleString() + "원";

                        feather.replace();
                    }
                });
            } else {
                userInfoSection.innerHTML = `
                    <div class="text-center py-4">
                        <p class="text-gray-400">로그인이 필요합니다</p>
                        <a href="index.html" class="text-orange-400 hover:text-orange-300 text-sm">로그인 페이지로 이동</a>
                    </div>
                `;
            }
        }

        function refreshBalance() {
            const user = auth.currentUser;
            if (user) {
                db.collection("users").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        const userData = doc.data();
                        document.getElementById("currentBalance").textContent = (userData.balance || 0).toLocaleString() + "원";
                    }
                });
            }
        }

        // Tab Management
        document.getElementById("exchangeRequestTab").addEventListener("click", function() {
            showExchangeTab('request');
            document.getElementById("exchangeRequestTab").classList.add("active-tab");
            document.getElementById("exchangeHistoryTab").classList.remove("active-tab");
            const req = document.getElementById("exchangeRequestContent");
            const his = document.getElementById("exchangeHistoryContent");
            req.classList.add("active"); req.classList.remove("hidden");
            his.classList.remove("active"); his.classList.add("hidden");
            refreshBalance();
        });

        document.getElementById("exchangeHistoryTab").addEventListener("click", function() {
            showExchangeTab('history');
            loadExchangeHistory(true);
            document.getElementById("exchangeHistoryTab").classList.add("active-tab");
            document.getElementById("exchangeRequestTab").classList.remove("active-tab");
            document.getElementById("exchangeHistoryContent").classList.add("active");
            document.getElementById("exchangeRequestContent").classList.remove("active");
            const req = document.getElementById("exchangeRequestContent"); const his = document.getElementById("exchangeHistoryContent"); his.classList.remove("hidden"); req.classList.add("hidden"); loadExchangeHistory();
        });

        // Amount Selection
        let currentExchangeAmount = 0;
        let selectedPreset = null;

        function selectExchangeAmount(amount) {
            currentExchangeAmount = amount;
            document.getElementById("exchangeAmount").value = amount.toLocaleString() + '원';
            
            // Remove active class from all buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            event.target.classList.add('active');
            selectedPreset = amount;
        }

        // Custom amount input
        document.getElementById('exchangeAmount').addEventListener('input', function(e) {
            const value = e.target.value.replace(/[^0-9]/g, '');
            currentExchangeAmount = value ? parseInt(value) : 0;
            e.target.value = value ? parseInt(value).toLocaleString() + '원' : '';
            
            // Remove active class from preset buttons when typing
            if (value && selectedPreset) {
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                selectedPreset = null;
            }
        });

        // Exchange Submission
        document.getElementById("submitExchangeBtn").addEventListener("click", async function() {
            const password = document.getElementById("exchangePassword").value.trim();

            if (!currentExchangeAmount || currentExchangeAmount < 10000) {
                alert("최소 10,000원 이상 입력해주세요");
                return;
            }

            if (currentExchangeAmount % 10000 !== 0) {
                alert("10,000원 단위로만 환전 가능합니다");
                return;
            }

            if (!password) {
                alert("출금 비밀번호를 입력해주세요");
                return;
            }

            showLoading();
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("로그인이 필요합니다");

                const userDoc = await db.collection("users").doc(user.uid).get();
                if (!userDoc.exists) throw new Error("사용자 정보를 찾을 수 없습니다");

                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;

                if (currentBalance < currentExchangeAmount) {
                    throw new Error("보유금액이 부족합니다");
                }

                // Verify withdraw password
                if (!bcrypt || typeof bcrypt.compareSync !== "function") {
                    alert("암호화 라이브러리가 로딩되지 않았습니다.");
                    return;
                }

                if (!bcrypt.compareSync(password, userData.withdrawPassword)) {
                    throw new Error("출금 비밀번호가 일치하지 않습니다");
                }

                // Submit exchange request
                await db.runTransaction(async (tx) => {
                    // Update user balance
                    tx.update(db.collection("users").doc(user.uid), {
                        balance: currentBalance - currentExchangeAmount
                    });

                    // Create exchange request
                    const exchangeRef = db.collection("exchangeRequests").doc();
                    tx.set(exchangeRef, {
                        userId: user.uid,
                        userName: userData.name || userData.userId,
                        amount: currentExchangeAmount,
                        bank: userData.bank,
                        account: userData.account,
                        accountName: userData.accountName,
                        date: new Date().toISOString(),
                        status: "pending",
                        adminNote: "",
                        processedDate: null,
                    });
                });

                // Show success notification
                showExchangeSuccessNotification(currentExchangeAmount);
                
                // Reset form
                document.getElementById("exchangePassword").value = "";
                document.getElementById("exchangeAmount").value = "";
                currentExchangeAmount = 0;
                document.querySelectorAll('.preset-btn').forEach(btn => btn.classList.remove('active'));
                selectedPreset = null;
                
                // Refresh balance
                refreshBalance();
                
            } catch (error) {
                console.error("환전 신청 오류:", error);
                alert("환전 신청 중 오류가 발생했습니다: " + error.message);
            } finally {
                hideLoading();
            }
        });

        function showExchangeSuccessNotification(amount) {
            const notification = document.createElement("div");
            notification.className = "fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.innerHTML = `
                <div class="flex items-center">
                    <i data-feather="check-circle" class="w-5 h-5 mr-2"></i>
                    ${amount.toLocaleString()}원 환전 신청 완료!
                </div>
            `;
            document.body.appendChild(notification);
            feather.replace();

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Load Exchange History
        function loadExchangeHistory() {
            const historyList = document.getElementById("exchangeHistoryList");
            const user = auth.currentUser;

            if (!user) {
                historyList.innerHTML = '<div class="text-center text-gray-400 py-4">로그인이 필요합니다</div>';
                return;
            }

            showLoading();
            db.collection("exchangeRequests")
                .where("userId", "==", user.uid)
                .orderBy("date", "desc")
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        historyList.innerHTML = '<div class="text-center text-gray-400 py-4">환전 내역이 없습니다</div>';
                        return;
                    }

                    historyList.innerHTML = "";
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();
                        const historyItem = document.createElement("div");
                        historyItem.className = "flex justify-between items-center bg-gray-700 p-3 rounded";
                        
                        let statusClass = "text-yellow-400";
                        let statusText = "대기중";

                        if (item.status === "completed") {
                            statusClass = "text-green-400";
                            statusText = "처리완료";
                        } else if (item.status === "rejected") {
                            statusClass = "text-red-400";
                            statusText = "거절됨";
                        }

                        historyItem.innerHTML = `
                            <div>
                                <div class="text-sm">${new Date(item.date).toLocaleString()}</div>
                                <div class="text-xs text-gray-400">${item.bank} ${item.account}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold">${item.amount.toLocaleString()}원</div>
                                <div class="text-xs ${statusClass}">${statusText}</div>
                            </div>
                        `;
                        historyList.appendChild(historyItem);
                    });
                })
                .catch((error) => {
                    console.error("환전 내역 로드 오류:", error);
                    historyList.innerHTML = '<div class="text-center text-red-400 py-4">내역을 불러오는 중 오류 발생</div>';
                })
                .finally(() => hideLoading());
        }

        // Initialize
        feather.replace();
        auth.onAuthStateChanged((user) => {
            showExchangeTab('request');
            updateUserInfo(user);
        });
    </script>
</body>
</html>
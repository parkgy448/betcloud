<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Exchange | BetCloud Revolution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Firebase (v8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bcryptjs/2.4.3/bcrypt.min.js"></script>
    <script src="auth.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Oxanium:wght@400;600;800&display=swap');
        body { font-family: 'Oxanium', sans-serif; background-color: #0a0a12; color: white; }
        .active-tab { background-color: #f97316; color: white; }
        .preset-btn.active { background-color: #f97316; color: white; }
    </style>
</head>
<body class="min-h-screen pt-20">
    <div class="container mx-auto px-4 py-6">
        

<header class="flex justify-between items-center fixed top-0 left-0 w-full z-50 bg-black/60 backdrop-blur-md py-3 px-4">
  <div></div>
  <img src="https://i.ibb.co/xdhYSGr/logo.png" alt="LEAVES Logo" class="h-12 md:h-16 object-contain mx-auto">
  <a href="index.html" class="text-gray-400 hover:text-white">
    <i data-feather="x"></i>
  </a>
</header>



        <div id="userInfoSection" class="bg-gray-800 rounded-lg p-4 mb-6"></div>

        <div class="flex border-b border-gray-700 mb-6">
            <button id="exchangeRequestTab" class="flex-1 py-2 font-bold active-tab">환전하기</button>
            <button id="exchangeHistoryTab" class="flex-1 py-2 font-bold text-gray-400">환전내역</button>
        </div>

        <div id="exchangeRequestContent" class="exchange-tab-content">
            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">환전계좌정보</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-1">출금비밀번호</label>
                        <div class="relative">
                            <input type="password" id="exchangePassword" class="w-full bg-gray-700 rounded p-2 pr-10" placeholder="출금비밀번호 입력">
                            <button onclick="togglePassword('exchangePassword','exchangeEyeIcon')" class="absolute right-2 top-2 text-gray-400 hover:text-white">
                                <i data-feather="eye" id="exchangeEyeIcon" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                    <div><label class="block text-sm text-gray-400 mb-1">은행명</label><div id="userBank" class="bg-gray-700 rounded p-2">-</div></div>
                    <div><label class="block text-sm text-gray-400 mb-1">계좌번호</label><div id="userAccount" class="bg-gray-700 rounded p-2">-</div></div>
                    <div><label class="block text-sm text-gray-400 mb-1">예금주</label><div id="userAccountName" class="bg-gray-700 rounded p-2">-</div></div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg p-4 mb-6">
                <h3 class="font-bold mb-4">환전금액</h3>
                <div class="mb-4">
                    <div class="flex items-center mb-2"><span class="text-sm text-gray-400 mr-2">현재 잔액:</span><span id="currentBalance" class="font-bold text-orange-400">0원</span></div>
                    <input type="text" id="exchangeAmount" class="w-full bg-gray-700 rounded p-2 mb-2" placeholder="직접 입력 (숫자만)">
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="selectExchangeAmount(10000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">10,000원</button>
                        <button onclick="selectExchangeAmount(30000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">30,000원</button>
                        <button onclick="selectExchangeAmount(50000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">50,000원</button>
                        <button onclick="selectExchangeAmount(100000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">100,000원</button>
                        <button onclick="selectExchangeAmount(500000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">500,000원</button>
                        <button onclick="selectExchangeAmount(1000000)" class="preset-btn bg-gray-700 py-3 rounded hover:bg-gray-600">1,000,000원</button>
                    </div>
                </div>
                <button id="submitExchangeBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-bold">환전신청</button>
            </div>
        </div>

        <div id="exchangeHistoryContent" class="exchange-tab-content hidden">
            <div class="bg-gray-800 rounded-lg p-4">
                <h3 class="font-bold mb-4">환전 내역</h3>
                <div id="exchangeHistoryList" class="space-y-2"></div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-4">롤링 현황</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div><div class="flex justify-between mb-1"><span>스포츠</span><span>0% (0원)</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div></div></div>
                <div><div class="flex justify-between mb-1"><span>미니게임</span><span>0% (0원)</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div></div></div>
                <div><div class="flex justify-between mb-1"><span>카지노</span><span>0% (0원)</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div></div></div>
                <div><div class="flex justify-between mb-1"><span>슬롯</span><span>0% (0원)</span></div><div class="w-full bg-gray-700 rounded-full h-2"><div class="bg-orange-500 h-2 rounded-full" style="width: 0%"></div></div></div>
            </div>
        </div>

        <div class="bg-gray-800 rounded-lg p-4 mb-6">
            <h3 class="font-bold mb-3 text-red-400">환전 전 필독사항</h3>
            <ul class="space-y-3 text-sm">
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>1회 최소 환전 금액은 <span class="text-orange-400">10,000원</span>부터 가능 / 1회 최대 환전금액 : <span class="text-orange-400">무제한</span></span></li>
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>레벨별 1일 최대 환전금액 : 전레벨 - 무제한</span></li>
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>재환전 대기시간은 없습니다. (다만 짧은 시간에 환전을 계속 누르는 행위는 피해주시길 부탁드립니다)</span></li>
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>중복 환전신청은 전부 취소처리 되며 환전신청 도중 중복 환전신청은 불가합니다.</span></li>
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>모든 환전은 순차적으로 진행되며 환전대기인원이 많을 경우 최대 30분까지 소요될 수 있는 점 양해바랍니다.</span></li>
                <li class="flex items-start"><i data-feather="alert-circle" class="text-orange-400 mr-2 w-4 h-4 mt-0.5"></i><span>회원가입 시 기재된 본인 명의로 된 계좌로만 출금이 가능합니다.</span></li>
            </ul>
        </div>

        <footer class="text-center text-xs text-gray-500 mt-6"><p>COPYRIGHT © LEAVES CASINO ALL RIGHTS RESERVED</p></footer>
    </div>

    <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 flex items-center">
            <i data-feather="loader" class="w-8 h-8 text-orange-500 animate-spin mr-3"></i>
            <span id="loadingText">로딩중입니다......... 잠시만 기다려주세요.</span>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAr_S6URDXWbjQ4Gh0Nw_JOeTkHA_G8Uis",
            authDomain: "cloud-casino-34cc6.firebaseapp.com",
            projectId: "cloud-casino-34cc6",
            storageBucket: "cloud-casino-34cc6.firebasestorage.app",
            messagingSenderId: "289867400095",
            appId: "1:289867400095:web:c9060c2a534225db9cf3aa"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        function showLoading(text){ if(text) document.getElementById("loadingText").textContent = text; document.getElementById("loadingSpinner").classList.remove("hidden");}
        function hideLoading(){ document.getElementById("loadingSpinner").classList.add("hidden");}
        function togglePassword(inputId, iconId){ const passwordInput = document.getElementById(inputId); const eyeIcon = document.getElementById(iconId); if (passwordInput.type === 'password'){ passwordInput.type='text'; eyeIcon.setAttribute('data-feather','eye-off'); } else { passwordInput.type='password'; eyeIcon.setAttribute('data-feather','eye'); } feather.replace(); }

        // --- NEW: robust timestamp formatter ---
        function formatTimestamp(ts) {
            if (!ts) return "-";
            try {
                let d = null;
                // Firestore Timestamp object (has toDate())
                if (ts.toDate && typeof ts.toDate === 'function') {
                    d = ts.toDate();
                // Possibly an object with seconds & nanoseconds (e.g., serialized)
                } else if (typeof ts === 'object' && (ts.seconds || ts.nanoseconds)) {
                    const seconds = ts.seconds || 0;
                    const nanos = ts.nanoseconds || 0;
                    d = new Date(seconds * 1000 + Math.floor(nanos / 1e6));
                // numeric epoch millis
                } else if (typeof ts === 'number') {
                    d = new Date(ts);
                } else {
                    return "-";
                }
                // Format to match existing UI: "2025. 10. 8. 오후 8:01:18"
                const datePart = d.toLocaleDateString('ko-KR'); // e.g., "2025. 10. 8."
                const timePart = d.toLocaleTimeString('ko-KR', { hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
                return `${datePart} ${timePart}`;
            } catch (e) {
                console.error("formatTimestamp error:", e, ts);
                return "-";
            }
        }
        // --- END new formatter ---

        function updateUserInfo(user){
            const userInfoSection = document.getElementById("userInfoSection");
            if (user){
                db.collection("users").doc(user.uid).get().then((doc)=>{
                    if (doc.exists){
                        const userData = doc.data();
                        userInfoSection.innerHTML = `<div class="flex justify-between items-center"><div><h3 class="font-bold">${userData.name||userData.userId} 님</h3><div class="flex items-center space-x-2 mt-2"><span class="bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded">${(userData.point||0).toLocaleString()}P</span><span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${(userData.balance||0).toLocaleString()}원</span></div></div><button onclick="refreshBalance()" class="text-gray-400 hover:text-white"><i data-feather="refresh-cw"></i></button></div>`;
                        document.getElementById("userBank").textContent = userData.bank || "-";
                        document.getElementById("userAccount").textContent = userData.account ? userData.account.replace(/(\d{3})(\d{4})(\d{4})/,"$1-****-$3") : "-";
                        document.getElementById("userAccountName").textContent = userData.accountName || "-";
                        document.getElementById("currentBalance").textContent = (userData.balance||0).toLocaleString() + "원";
                        feather.replace();
                    }
                });
            } else {
                userInfoSection.innerHTML = `<div class="text-center py-4"><p class="text-gray-400">로그인이 필요합니다</p><a href="index.html" class="text-orange-400 hover:text-orange-300 text-sm">로그인 페이지로 이동</a></div>`;
            }
        }

        function refreshBalance(){ const user = auth.currentUser; if(user){ db.collection("users").doc(user.uid).get().then(doc=>{ if(doc.exists) document.getElementById("currentBalance").textContent = (doc.data().balance||0).toLocaleString() + "원"; }); } }

        document.getElementById("exchangeRequestTab").addEventListener("click", ()=>{
            document.getElementById("exchangeRequestTab").classList.add("active-tab");
            document.getElementById("exchangeHistoryTab").classList.remove("active-tab");
            // show request, hide history
            document.getElementById("exchangeRequestContent").classList.remove("hidden");
            document.getElementById("exchangeHistoryContent").classList.add("hidden");
            refreshBalance();
        });
        document.getElementById("exchangeHistoryTab").addEventListener("click", ()=>{
            document.getElementById("exchangeHistoryTab").classList.add("active-tab");
            document.getElementById("exchangeRequestTab").classList.remove("active-tab");
            // show history, hide request
            document.getElementById("exchangeHistoryContent").classList.remove("hidden");
            document.getElementById("exchangeRequestContent").classList.add("hidden");
            subscribeExchangeHistory();
        });

        let currentExchangeAmount = 0, selectedPreset = null;
        function selectExchangeAmount(amount){
            currentExchangeAmount = amount;
            document.getElementById("exchangeAmount").value = amount.toLocaleString() + '원';
            document.querySelectorAll('.preset-btn').forEach(btn=>btn.classList.remove('active'));
            try{ event.target.classList.add('active'); }catch(e){}
            selectedPreset = amount;
        }
        document.getElementById('exchangeAmount').addEventListener('input', function(e){
            const value = e.target.value.replace(/[^0-9]/g,'');
            currentExchangeAmount = value ? parseInt(value,10) : 0;
            e.target.value = value ? parseInt(value,10).toLocaleString() + '원' : '';
            if (value && selectedPreset){ document.querySelectorAll('.preset-btn').forEach(btn=>btn.classList.remove('active')); selectedPreset = null; }
        });

        document.getElementById("submitExchangeBtn").addEventListener("click", async function(){
            const password = document.getElementById("exchangePassword").value.trim();
            if (!currentExchangeAmount || currentExchangeAmount < 10000) { alert("최소 10,000원 이상 입력해주세요"); return; }
            if (currentExchangeAmount % 10000 !== 0) { alert("10,000원 단위로만 환전 가능합니다"); return; }
            if (!password) { alert("출금 비밀번호를 입력해주세요"); return; }

            showLoading("환전신청을 처리중입니다...");
            try {
                const user = auth.currentUser;
                if (!user) throw new Error("로그인이 필요합니다");
                const userDoc = await db.collection("users").doc(user.uid).get();
                if (!userDoc.exists) throw new Error("사용자 정보를 찾을 수 없습니다");
                const userData = userDoc.data();
                const currentBalance = userData.balance || 0;
                if (currentBalance < currentExchangeAmount) throw new Error("보유금액이 부족합니다");

                const BCRYPT = window.bcrypt || (window.dcodeIO && window.dcodeIO.bcrypt);
                if (!BCRYPT || typeof BCRYPT.compareSync !== "function") { alert("암호화 라이브러리가 로딩되지 않았습니다."); return; }

                const storedPwd = userData.withdrawPassword || "";
                const looksHashed = /^\$2[aby]\$/.test(storedPwd);
                const verified = looksHashed ? (BCRYPT && BCRYPT.compareSync(password, storedPwd)) : (password === storedPwd);
                if (!verified) throw new Error("출금 비밀번호가 일치하지 않습니다");

                // transaction: update balance and create exchangeRequests with server timestamp
                await db.runTransaction(async (tx) => {
                    const userRef = db.collection("users").doc(user.uid);
                    const userSnap = await tx.get(userRef);
                    const prevBalance = (userSnap.exists && userSnap.data().balance) || 0;
                    if (prevBalance < currentExchangeAmount) throw new Error("보유금액이 부족합니다 (트랜잭션 검사)");

                    tx.update(userRef, { balance: prevBalance - currentExchangeAmount });

                    const exchangeRef = db.collection("exchangeRequests").doc();
                    tx.set(exchangeRef, {
                        userId: user.uid,
                        userName: userData.name || userData.userId,
                        amount: currentExchangeAmount,
                        bank: userData.bank || "",
                        account: userData.account || "",
                        accountName: userData.accountName || "",
                        date: firebase.firestore.FieldValue.serverTimestamp(),
                        status: "pending",
                        adminNote: "",
                        processedDate: null
                    });
                });

                showExchangeSuccessNotification(currentExchangeAmount);
                // reset UI
                document.getElementById("exchangePassword").value = "";
                document.getElementById("exchangeAmount").value = "";
                currentExchangeAmount = 0;
                document.querySelectorAll('.preset-btn').forEach(btn=>btn.classList.remove('active'));
                selectedPreset = null;
                refreshBalance();
            } catch (err) {
                console.error("환전 신청 오류:", err);
                alert("환전 신청 중 오류가 발생했습니다: " + (err.message || err));
            } finally { hideLoading(); }
        });

        function showExchangeSuccessNotification(amount){
            const notification = document.createElement("div");
            notification.className = "fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50";
            notification.innerHTML = `<div class="flex items-center"><i data-feather="check-circle" class="w-5 h-5 mr-2"></i>${amount.toLocaleString()}원 환전 신청 완료!</div>`;
            document.body.appendChild(notification);
            feather.replace();
            setTimeout(()=>notification.remove(),3000);
        }

        // Real-time exchange history subscription
        let exchangeHistoryUnsub = null;
        function subscribeExchangeHistory() {
            const historyList = document.getElementById("exchangeHistoryList");
            const user = auth.currentUser;
            if (!user) { historyList.innerHTML = '<div class="text-center text-gray-400 py-4">로그인이 필요합니다</div>'; return; }
            historyList.innerHTML = '<div class="text-center text-gray-400 py-4">로딩중입니다......... 잠시만 기다려주세요.</div>';
            if (exchangeHistoryUnsub) exchangeHistoryUnsub();

            exchangeHistoryUnsub = db.collection("exchangeRequests")
                .where("userId","==", user.uid)
                .orderBy("date","desc")
                .onSnapshot((querySnapshot) => {
                    if (querySnapshot.empty) { historyList.innerHTML = '<div class="text-center text-gray-400 py-4">환전 내역이 없습니다</div>'; return; }
                    historyList.innerHTML = "";
                    querySnapshot.forEach((doc) => {
                        const item = doc.data();

                        // --- UPDATED: use robust formatter + fallback to processedDate ---
                        let date = "-";
                        if (item.date) date = formatTimestamp(item.date);
                        if (date === "-" && item.processedDate) date = formatTimestamp(item.processedDate);
                        // if still '-', leave as '-'
                        // --- END updated logic ---

                        let statusClass = "text-yellow-400", statusText = "대기중";
                        if (item.status === "completed") { statusClass = "text-green-400"; statusText = "처리완료"; }
                        else if (item.status === "rejected") { statusClass = "text-red-400"; statusText = "거절됨"; }

                        const historyItem = document.createElement("div");
                        historyItem.className = "flex justify-between items-center bg-gray-700 p-3 rounded";
                        historyItem.innerHTML = `<div><div class="text-sm">${date}</div><div class="text-xs text-gray-400">${item.bank || ""} ${item.account || ""}</div></div>
                                                 <div class="text-right"><div class="font-bold">${(item.amount||0).toLocaleString()}원</div><div class="text-xs ${statusClass}">${statusText}</div></div>`;
                        historyList.appendChild(historyItem);
                    });
                }, (err) => {
                    console.error("환전 내역 구독 오류:", err);
                    historyList.innerHTML = '<div class="text-center text-red-400 py-4">내역을 불러오는 중 오류 발생</div>';
                });
        }

        feather.replace();
        auth.onAuthStateChanged((user) => {
            updateUserInfo(user);
            if (!user) {
                if (exchangeHistoryUnsub) { exchangeHistoryUnsub(); exchangeHistoryUnsub = null; }
            }
        });
    </script>
</body>
</html>
